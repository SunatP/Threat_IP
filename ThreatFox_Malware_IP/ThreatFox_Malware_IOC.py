# Import Lib
import requests
import datetime as dt
import pandas as pd
import shutil
import zipfile
import os
from time import sleep
# Download zip file and extract to the destination path 

today = dt.date.today()
url = "https://threatfox.abuse.ch/export/csv/ip-port/recent/"
dataset = requests.get(url,allow_redirects=True)
open((r"/home/sunat/FortiSIEM/ThreatFox_Dataset/Dataset_Malware_"+ str(today) + ".csv"),'wb').write(dataset.content)
os.chmod("/home/sunat/FortiSIEM/ThreatFox_Dataset/Dataset_Malware_"+ str(today) + ".csv",0o777)
os.replace(("/home/sunat/FortiSIEM/ThreatFox_Dataset/Dataset_Malware_"+ str(today) + ".csv"),("/home/sunat/FortiSIEM/ThreatFox_Dataset/Dataset_Malware_"+str(today)+".csv"))

# Extract File
# with zipfile.ZipFile(("/home/sunat/FortiSIEM/ThreatFox_Dataset/Dataset_Malware_"+str(today)+".zip"),'r') as zipfile_ref:
#     zipfile_ref.extractall("/home/sunat/FortiSIEM/ThreatFox_Dataset/")

sleep(1.25)

# os.replace(("/home/sunat/FortiSIEM/full_ip-port.csv"),("/home/sunat/FortiSIEM/ThreatFox_Dataset/full_ip-port.csv"))

# Read data
today = dt.date.today()
# open file
with open(("/home/sunat/FortiSIEM/ThreatFox_Dataset/Dataset_Malware_"+str(today)+".csv"),"r") as file:
    data = file.readlines()

for i in range(0,9,1): # replacing data
    print(data[i])
    data[i] = ""
data[0]= 'first_seen_utc,ioc_id,ioc_value,ioc_type,threat_type,fk_malware,malware_alias,malware_printable,last_seen_utc,confidence_level,reference,tags,anonymous,reporter,,,,,,,\n'
# Slicing index 
print(data[-1:])
data[-1:] = ""

with open(("/home/sunat/FortiSIEM/ThreatFox_Dataset/full_ip-port.csv"), 'w') as file:
    file.writelines( data )



df = pd.read_csv("/home/sunat/FortiSIEM/ThreatFox_Dataset/full_ip-port.csv",warn_bad_lines=False,error_bad_lines=False,sep=",")

# Drop unused columns

new_df = df.drop(['ioc_id','ioc_type','reference','malware_alias' ,'tags','malware_printable', 'fk_malware','last_seen_utc',
       'confidence_level','anonymous', 'reporter','Unnamed: 14', 'Unnamed: 15', 'Unnamed: 16', 'Unnamed: 17',
       'Unnamed: 18', 'Unnamed: 19', 'Unnamed: 20'],axis=1)

# Change Datetime pattern

new_df["first_seen_utc"] = new_df["first_seen_utc"].str.replace(r"(\d+)(:)(\d+):(\d+)","",regex=True)
new_df["first_seen_utc"] = new_df["first_seen_utc"].str.replace(r"-","/",regex=True)

# Replace port number to whitespace or Null

new_df["ioc_value"] = new_df["ioc_value"].str.replace(r"(:)(\d+)","",regex=True)
new_df["ioc_value"] = new_df["ioc_value"].str.replace(r'(")',"",regex=True)

new_df["ioc_value"][0]

# Add new column with header name

new_df["Name"] = new_df["ioc_value"]
new_df["High IP"] = new_df["ioc_value"]
new_df["Confidence"] = [" "] * new_df.shape[0]
new_df["Severity"] = [" "] * new_df.shape[0]
new_df["ASN"] = [" "] * new_df.shape[0]
new_df["Org"] = [" "] * new_df.shape[0]
new_df["Country"] = [" "] * new_df.shape[0]
new_df["Description"] = ["ThreatFox IOCs"] * new_df.shape[0]
new_df["Date Found"] = new_df['first_seen_utc']

# Change the column name

new_df.columns=['Last Seen','Low IP','Malware Type','Name','High IP','Confidence','Severity','ASN','Org','Country','Description','Date Found']

# Re-Arrange Column

new_df = new_df[['Name','Low IP','High IP','Malware Type','Confidence','Severity','ASN','Org','Country','Description','Date Found','Last Seen']]

# Export to CSV file

today = dt.date.today()
new_df.to_csv (r'/home/sunat/FortiSIEM/ThreatFox_Dataset/ThreatFox_Bot_C2_Out_'+ str(today)+'.csv', index = False, header=True, encoding="utf-8-sig")
print("OK at",today)
